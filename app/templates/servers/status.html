{% extends "base.html" %}

{% block title %}Server Status: {{ server.name }} - NEXPOSTGRES{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        transition: all 0.3s;
    }
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .progress {
        height: 10px;
    }
    .status-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .status-online {
        background-color: #28a745;
    }
    .status-offline {
        background-color: #dc3545;
    }
    .status-loading {
        background-color: #ffc107;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { opacity: 0.5; }
        50% { opacity: 1; }
        100% { opacity: 0.5; }
    }
    .server-actions button {
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>Server Status</h1>
        <h4>{{ server.name }} ({{ server.host }})</h4>
    </div>
    <div class="d-flex align-items-center">
        <span id="connection-status">
            <span class="status-indicator status-loading"></span> Connecting...
        </span>
        <a href="{{ url_for('servers.index') }}" class="btn btn-outline-secondary ms-3">
            <i class="fas fa-arrow-left me-1"></i> Back to Servers
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> System Information</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tbody>
                        <tr>
                            <th width="35%"><i class="fas fa-server me-2"></i> Operating System</th>
                            <td id="os-info"><div class="placeholder-glow"><span class="placeholder col-9"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-network-wired me-2"></i> Public IPv4</th>
                            <td id="ip-info"><div class="placeholder-glow"><span class="placeholder col-6"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-microchip me-2"></i> vCPU</th>
                            <td id="vcpu-info"><div class="placeholder-glow"><span class="placeholder col-3"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-memory me-2"></i> RAM</th>
                            <td id="ram-info"><div class="placeholder-glow"><span class="placeholder col-7"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-hdd me-2"></i> Local Disk</th>
                            <td id="disk-info"><div class="placeholder-glow"><span class="placeholder col-8"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-database me-2"></i> PostgreSQL</th>
                            <td id="postgres-version"><div class="placeholder-glow"><span class="placeholder col-6"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-archive me-2"></i> WAL-G</th>
                            <td id="walg-version"><div class="placeholder-glow"><span class="placeholder col-6"></span></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Resource Usage</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong>CPU Usage</strong>
                        <span id="cpu-percent">--%</span>
                    </div>
                    <div class="progress">
                        <div id="cpu-progress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong>Memory Usage</strong>
                        <span id="memory-percent">--%</span>
                    </div>
                    <div class="progress">
                        <div id="memory-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong>Disk Usage</strong>
                        <span id="disk-percent">--%</span>
                    </div>
                    <div class="progress">
                        <div id="disk-progress" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <p><small>Auto-refreshing every 30 seconds</small></p>
                    <button id="refresh-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt me-1"></i> Refresh Now
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i> Server Controls</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> These actions may cause temporary service disruptions.
                </div>
                
                <div class="server-actions">
                    <button id="restart-btn" class="btn btn-warning">
                        <i class="fas fa-power-off me-1"></i> Restart Server
                    </button>
                    
                    <button id="update-btn" class="btn btn-info">
                        <i class="fas fa-download me-1"></i> Update Server
                    </button>
                    
                    <button id="configure-ip-rules-btn" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#ipRulesConfigModal">
                        <i class="fas fa-network-wired me-1"></i> Configure IP Rules
                    </button>
                    
                    <button id="configure-ssl-btn" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#sslConfigModal">
                        <i class="fas fa-lock me-1"></i> Configure SSL/TLS
                    </button>
                </div>
                
                <div id="action-status" class="mt-3">
                    <!-- Action status messages will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- IP Rules Configuration Modal -->
<div class="modal fade" id="ipRulesConfigModal" tabindex="-1" aria-labelledby="ipRulesConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ipRulesConfigModalLabel">
                    <i class="fas fa-network-wired me-2"></i>IP Rules Configuration
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ipRulesConfigForm">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Configure IP access rules for PostgreSQL.</strong> These settings control which IP addresses can connect to your PostgreSQL server.
                    </div>
                    
                    <!-- IP Access Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-network-wired me-2"></i>IP Access Control</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Access Type</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="ipAccessType" id="ipAccessAll" value="all" checked>
                                    <label class="form-check-label" for="ipAccessAll">
                                        <strong>Allow All IPs (0.0.0.0/0)</strong>
                                        <small class="text-muted d-block">Allows connections from any IP address</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="ipAccessType" id="ipAccessSpecific" value="specific">
                                    <label class="form-check-label" for="ipAccessSpecific">
                                        <strong>Specific IP Addresses</strong>
                                        <small class="text-muted d-block">Only allow connections from specified IPs</small>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="ipSpecificIpsContainer" class="d-none">
                                <label for="ipAllowedIps" class="form-label">Allowed IP Addresses</label>
                                <textarea class="form-control" id="ipAllowedIps" rows="3" placeholder="Enter IP addresses or CIDR blocks, one per line:\n192.168.1.100\n10.0.0.0/24\n203.0.113.5"></textarea>
                                <div class="form-text">Enter IP addresses or CIDR blocks, one per line. Examples: 192.168.1.100, 10.0.0.0/24</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Authentication Method -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Authentication Method</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Authentication Method</label>
                                <div class="form-control-plaintext">
                                    <strong>SCRAM-SHA-256</strong> <span class="text-muted">(Most Secure)</span>
                                </div>
                                <div class="form-text">Using the most secure authentication method available</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration Preview -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Configuration Preview</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">postgresql.conf changes:</label>
                                <pre class="bg-light p-2 rounded"><code id="ipPostgresqlConfPreview">listen_addresses = '*'</code></pre>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">pg_hba.conf entries:</label>
                                <pre class="bg-light p-2 rounded"><code id="ipPgHbaConfPreview">host    all    all    0.0.0.0/0    scram-sha-256\nhost    all    all    ::/0         scram-sha-256</code></pre>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Validation Options -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Safety Options</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="ipValidateConfig" checked disabled>
                                <label class="form-check-label" for="ipValidateConfig">
                                    <strong>Validate configuration before applying</strong>
                                    <small class="text-muted d-block">Test configuration syntax before restarting PostgreSQL (Always enabled)</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="applyIpRulesBtn">
                    <i class="fas fa-network-wired me-1"></i>Apply IP Rules
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SSL/TLS Configuration Modal -->
<div class="modal fade" id="sslConfigModal" tabindex="-1" aria-labelledby="sslConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sslConfigModalLabel">
                    <i class="fas fa-lock me-2"></i>SSL/TLS Configuration
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sslConfigForm">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Configure SSL/TLS encryption for PostgreSQL.</strong> These settings control how connections to your PostgreSQL server are encrypted.
                    </div>
                    
                    <!-- SSL/TLS Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-lock me-2"></i>SSL/TLS Configuration</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="sslEnableSsl" checked>
                                <label class="form-check-label" for="sslEnableSsl">
                                    <strong>Enable SSL/TLS</strong>
                                    <small class="text-muted d-block">Encrypt connections to PostgreSQL</small>
                                </label>
                            </div>
                            
                            <div id="sslOptionsContainer">
                                <div class="mb-3">
                                    <label class="form-label">Certificate Management</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sslCertType" id="sslAutoGenerate" value="auto" checked>
                                        <label class="form-check-label" for="sslAutoGenerate">
                                            <strong>Auto-generate certificates</strong>
                                            <small class="text-muted d-block">Automatically create self-signed certificates</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sslCertType" id="sslCustomCerts" value="custom">
                                        <label class="form-check-label" for="sslCustomCerts">
                                            <strong>Use custom certificates</strong>
                                            <small class="text-muted d-block">Provide paths to existing certificate files</small>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="sslCustomCertContainer" class="d-none">
                                    <div class="mb-3">
                                        <label for="sslCertPath" class="form-label">Certificate Path</label>
                                        <input type="text" class="form-control" id="sslCertPath" placeholder="/path/to/server.crt">
                                        <div class="form-text">Path to the SSL certificate file</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="sslKeyPath" class="form-label">Private Key Path</label>
                                        <input type="text" class="form-control" id="sslKeyPath" placeholder="/path/to/server.key">
                                        <div class="form-text">Path to the SSL private key file</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Validation Options -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Safety Options</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sslValidateConfig" checked disabled>
                                <label class="form-check-label" for="sslValidateConfig">
                                    <strong>Validate configuration before applying</strong>
                                    <small class="text-muted d-block">Test configuration syntax before restarting PostgreSQL (Always enabled)</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="applySslBtn">
                    <i class="fas fa-lock me-1"></i>Apply SSL/TLS
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const serverId = {{ server.id }};
        let refreshInterval;
        
        // Function to fetch server status data
        function fetchServerStatus() {
            document.getElementById('connection-status').innerHTML = '<span class="status-indicator status-loading"></span> Connecting...';
            
            fetch(`{{ url_for('servers.status_data', id=server.id) }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update connection status
                        document.getElementById('connection-status').innerHTML = '<span class="status-indicator status-online"></span> Online';
                        
                        // Update system info
                        document.getElementById('os-info').textContent = data.os;
                        document.getElementById('ip-info').textContent = data.ip;
                        document.getElementById('vcpu-info').textContent = data.vcpu;
                        document.getElementById('ram-info').textContent = `${data.ram.used} MB / ${data.ram.total} MB`;
                        document.getElementById('disk-info').textContent = `${data.disk.used} / ${data.disk.total} (${data.disk.free} free)`;
                        document.getElementById('postgres-version').textContent = data.postgres_version;
                        document.getElementById('walg-version').textContent = data.walg_version;
                        
                        // Update resource usage
                        document.getElementById('cpu-percent').textContent = `${data.cpu_usage_percent}%`;
                        document.getElementById('cpu-progress').style.width = `${data.cpu_usage_percent}%`;
                        
                        document.getElementById('memory-percent').textContent = `${data.ram.usage_percent}%`;
                        document.getElementById('memory-progress').style.width = `${data.ram.usage_percent}%`;
                        
                        document.getElementById('disk-percent').textContent = `${data.disk.usage_percent}%`;
                        document.getElementById('disk-progress').style.width = `${data.disk.usage_percent}%`;
                        
                        // Set progress bar colors based on usage
                        setCpuProgressColor(data.cpu_usage_percent);
                        setMemoryProgressColor(data.ram.usage_percent);
                        setDiskProgressColor(data.disk.usage_percent);
                    } else {
                        // Show connection error
                        document.getElementById('connection-status').innerHTML = '<span class="status-indicator status-offline"></span> Offline';
                        showError(`Failed to connect to server: ${data.message}`);
                    }
                })
                .catch(error => {
                    document.getElementById('connection-status').innerHTML = '<span class="status-indicator status-offline"></span> Offline';
                    showError(`Error fetching server status: ${error.message}`);
                });
        }
        
        // Set progress bar colors based on usage thresholds
        function setCpuProgressColor(percent) {
            const progressBar = document.getElementById('cpu-progress');
            if (percent > 80) {
                progressBar.className = 'progress-bar bg-danger';
            } else if (percent > 60) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-info';
            }
        }
        
        function setMemoryProgressColor(percent) {
            const progressBar = document.getElementById('memory-progress');
            if (percent > 80) {
                progressBar.className = 'progress-bar bg-danger';
            } else if (percent > 60) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-success';
            }
        }
        
        function setDiskProgressColor(percent) {
            const progressBar = document.getElementById('disk-progress');
            if (percent > 90) {
                progressBar.className = 'progress-bar bg-danger';
            } else if (percent > 70) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-success';
            }
        }
        
        // Handle restart server button
        document.getElementById('restart-btn').addEventListener('click', function() {
            if (!confirm('Are you sure you want to restart this server? All services will be temporarily unavailable.')) {
                return;
            }
            
            const actionStatus = document.getElementById('action-status');
            actionStatus.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-1"></i> Restarting server...
                </div>
            `;
            
            csrfFetch(`{{ url_for('servers.restart_server', id=server.id) }}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actionStatus.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i> ${data.message}
                        </div>
                    `;
                    // Clear interval and show reconnecting message
                    clearInterval(refreshInterval);
                    setTimeout(() => {
                        document.getElementById('connection-status').innerHTML = 
                            '<span class="status-indicator status-loading"></span> Server restarting, will try to reconnect...';
                        // Try to reconnect after 1 minute
                        setTimeout(() => {
                            fetchServerStatus();
                            startAutoRefresh();
                        }, 60000);
                    }, 2000);
                } else {
                    actionStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-1"></i> ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                actionStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-1"></i> Error: ${error.message}
                    </div>
                `;
            });
        });
        
        // Handle update server button
        document.getElementById('update-btn').addEventListener('click', function() {
            if (!confirm('Are you sure you want to update this server? This may take some time to complete.')) {
                return;
            }
            
            const actionStatus = document.getElementById('action-status');
            actionStatus.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-1"></i> Updating server... This may take several minutes.
                </div>
            `;
            
            csrfFetch(`{{ url_for('servers.update_server', id=server.id) }}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actionStatus.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i> ${data.message}
                        </div>
                    `;
                } else {
                    actionStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-1"></i> ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                actionStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-1"></i> Error: ${error.message}
                    </div>
                `;
            });
        });
        
        // IP Rules Configuration Modal functionality
        function updateIpConfigPreview() {
            const accessType = document.querySelector('input[name="ipAccessType"]:checked').value;
            const authMethod = 'scram-sha-256'; // Fixed to most secure option
            const allowedIps = document.getElementById('ipAllowedIps').value;
            
            // Update postgresql.conf preview
            document.getElementById('ipPostgresqlConfPreview').textContent = "listen_addresses = '*'";
            
            // Update pg_hba.conf preview
            let pgHbaEntries = [];
            
            if (accessType === 'all') {
                pgHbaEntries.push(`host    all    all    0.0.0.0/0    ${authMethod}`);
                pgHbaEntries.push(`host    all    all    ::/0         ${authMethod}`);
            } else {
                const ips = allowedIps.split('\n').filter(ip => ip.trim() !== '');
                ips.forEach(ip => {
                    const cleanIp = ip.trim();
                    if (cleanIp) {
                        pgHbaEntries.push(`host    all    all    ${cleanIp.padEnd(15)}    ${authMethod}`);
                    }
                });
            }
            
            document.getElementById('ipPgHbaConfPreview').textContent = pgHbaEntries.join('\n');
        }
        
        // Load current IP Rules configuration
        function loadCurrentIpConfig() {
            fetch(`{{ url_for('servers.get_postgres_config', id=server.id) }}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.config) {
                    const config = data.config;
                    
                    // Set access type
                    if (config.access_type === 'all') {
                        document.getElementById('ipAccessAll').checked = true;
                        document.getElementById('ipSpecificIpsContainer').classList.add('d-none');
                    } else if (config.access_type === 'specific') {
                        document.getElementById('ipAccessSpecific').checked = true;
                        document.getElementById('ipSpecificIpsContainer').classList.remove('d-none');
                        
                        // Set allowed IPs
                        const allowedIpsText = config.allowed_ips.join('\n');
                        document.getElementById('ipAllowedIps').value = allowedIpsText;
                    } else {
                        // Default to 'all' if no configuration found
                        document.getElementById('ipAccessAll').checked = true;
                        document.getElementById('ipSpecificIpsContainer').classList.add('d-none');
                    }
                    
                    // Update preview with loaded configuration
                    updateIpConfigPreview();
                }
            })
            .catch(error => {
                console.error('Error loading current configuration:', error);
                // Set defaults on error
                document.getElementById('ipAccessAll').checked = true;
                document.getElementById('ipSpecificIpsContainer').classList.add('d-none');
                updateIpConfigPreview();
            });
        }
        
        // Load current SSL/TLS configuration
        function loadCurrentSslConfig() {
            fetch(`{{ url_for('servers.get_ssl_status', id=server.id) }}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.ssl_status) {
                    const sslStatus = data.ssl_status;
                    
                    // Update SSL enable checkbox
                    document.getElementById('sslEnableSsl').checked = sslStatus.ssl_enabled || false;
                    
                    // Update certificate paths if available
                    if (sslStatus.cert_file) {
                        document.getElementById('sslCertPath').value = sslStatus.cert_file;
                    }
                    if (sslStatus.key_file) {
                        document.getElementById('sslKeyPath').value = sslStatus.key_file;
                    }
                    
                    // Determine certificate type based on paths
                    if (sslStatus.cert_file && sslStatus.cert_file.includes('server.crt')) {
                        document.getElementById('sslAutoGenerate').checked = true;
                    } else if (sslStatus.cert_file) {
                        document.getElementById('sslCustomCerts').checked = true;
                    }
                    
                    // Trigger change events to show/hide fields
                    const enableSslEvent = new Event('change');
                    document.getElementById('sslEnableSsl').dispatchEvent(enableSslEvent);
                    if (document.getElementById('sslCustomCerts').checked) {
                        const customCertsEvent = new Event('change');
                        document.getElementById('sslCustomCerts').dispatchEvent(customCertsEvent);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading SSL status:', error);
            });
        }
        
        // Handle IP access type radio button changes
        document.querySelectorAll('input[name="ipAccessType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const specificContainer = document.getElementById('ipSpecificIpsContainer');
                if (specificContainer) {
                    if (this.value === 'specific') {
                        specificContainer.classList.remove('d-none');
                    } else {
                        specificContainer.classList.add('d-none');
                    }
                }
                updateIpConfigPreview();
            });
        });
        
        // Handle SSL/TLS configuration changes
        const sslEnableElement = document.getElementById('sslEnableSsl');
        if (sslEnableElement) {
            sslEnableElement.addEventListener('change', function() {
                const sslContainer = document.getElementById('sslOptionsContainer');
                if (sslContainer) {
                    if (this.checked) {
                        sslContainer.classList.remove('d-none');
                    } else {
                        sslContainer.classList.add('d-none');
                    }
                }
            });
        }
        
        // Handle certificate type radio button changes
        document.querySelectorAll('input[name="sslCertType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const customContainer = document.getElementById('sslCustomCertContainer');
                if (customContainer) {
                    if (this.value === 'custom') {
                        customContainer.classList.remove('d-none');
                    } else {
                        customContainer.classList.add('d-none');
                    }
                }
            });
        });
        
        // Handle allowed IPs textarea changes
        const ipAllowedIpsElement = document.getElementById('ipAllowedIps');
        if (ipAllowedIpsElement) {
            ipAllowedIpsElement.addEventListener('input', updateIpConfigPreview);
        }
        
        // Handle IP Rules apply configuration button
        const ipApplyBtn = document.getElementById('ipApplyConfigBtn');
        if (ipApplyBtn) {
            ipApplyBtn.addEventListener('click', function() {
            const actionStatus = document.getElementById('action-status');
            const modal = bootstrap.Modal.getInstance(document.getElementById('ipRulesConfigModal'));
            
            // Collect form data
            const formData = {
                access_type: document.querySelector('input[name="ipAccessType"]:checked').value,
                auth_method: 'scram-sha-256', // Fixed to most secure option
                allowed_ips: document.getElementById('ipAllowedIps').value,
                validate_config: true // Always validate configuration
            };
            
            // Close modal
            modal.hide();
            
            // Show loading status
            actionStatus.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-1"></i> Configuring PostgreSQL IP access rules...
                </div>
            `;
            
            // Send PostgreSQL access configuration request
            csrfFetch(`{{ url_for('servers.configure_postgres_access', id=server.id) }}`, {
                method: 'POST',
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                return Promise.resolve({ json: () => Promise.resolve(data) });
            })
            .then(response => {
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    let changeDetails = "";
                    
                    if (data.changes) {
                        changeDetails = "<ul>";
                        
                        if (data.changes.created_files) {
                            changeDetails += "<li><strong>Created missing configuration files</strong></li>";
                        }
                        
                        if (data.changes.listen_addresses) {
                            changeDetails += "<li>Updated postgresql.conf to allow external connections</li>";
                        }
                        
                        if (data.changes.pg_hba) {
                            const accessType = document.querySelector('input[name="ipAccessType"]:checked').value;
                            if (accessType === 'all') {
                                changeDetails += "<li>Updated pg_hba.conf to allow access from all IPs (0.0.0.0/0)</li>";
                            } else {
                                const allowedIps = document.getElementById('ipAllowedIps').value;
                                const ipCount = allowedIps.split('\n').filter(ip => ip.trim() !== '').length;
                                changeDetails += `<li>Updated pg_hba.conf to allow access from ${ipCount} specific IP${ipCount > 1 ? 's' : ''}</li>`;
                            }
                        }
                        
                        if (data.changes.validation_passed) {
                            changeDetails += "<li><strong>Configuration validation passed</strong></li>";
                        }
                        
                        changeDetails += "</ul>";
                    }
                    
                    actionStatus.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i> ${data.message}
                            ${changeDetails}
                        </div>
                    `;
                } else {
                    actionStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-1"></i> <strong>Error:</strong><br>
                            ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                actionStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-1"></i> Error: ${error.message}
                    </div>
                `;
            });
        });
        }
        
        // Handle SSL/TLS apply configuration button
        const sslApplyBtn = document.getElementById('sslApplyConfigBtn');
        if (sslApplyBtn) {
            sslApplyBtn.addEventListener('click', function() {
            const actionStatus = document.getElementById('action-status');
            const modal = bootstrap.Modal.getInstance(document.getElementById('sslConfigModal'));
            
            // Collect form data
            const formData = {
                enable_ssl: document.getElementById('sslEnableSsl').checked,
                auto_generate: document.querySelector('input[name="sslCertType"]:checked').value === 'auto',
                cert_path: document.getElementById('sslCertPath').value,
                key_path: document.getElementById('sslKeyPath').value
            };
            
            // Close modal
            modal.hide();
            
            // Show loading status
            actionStatus.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-1"></i> Configuring SSL/TLS settings...
                </div>
            `;
            
            // Send SSL configuration request
            csrfFetch(`{{ url_for('servers.configure_ssl', id=server.id) }}`, {
                method: 'POST',
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actionStatus.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i> ${data.message}
                        </div>
                    `;
                } else {
                    actionStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-1"></i> <strong>Error:</strong><br>
                            ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                actionStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-1"></i> Error: ${error.message}
                    </div>
                `;
            });
        });
        }
        
        // Handle modal show events to load current configuration
        const ipRulesModal = document.getElementById('ipRulesConfigModal');
        if (ipRulesModal) {
            ipRulesModal.addEventListener('show.bs.modal', function() {
                loadCurrentIpConfig();
            });
        }
        
        const sslModal = document.getElementById('sslConfigModal');
        if (sslModal) {
            sslModal.addEventListener('show.bs.modal', function() {
                loadCurrentSslConfig();
            });
        }
        
        // Initialize preview on page load
        updateIpConfigPreview();
        
        // Handle manual refresh
        document.getElementById('refresh-btn').addEventListener('click', function() {
            fetchServerStatus();
        });
        
        // Show error message
        function showError(message) {
            console.error(message);
        }
        
        // Auto-refresh every 30 seconds
        function startAutoRefresh() {
            refreshInterval = setInterval(fetchServerStatus, 30000);
        }
        
        // Initial fetch and start auto-refresh
        fetchServerStatus();
        startAutoRefresh();
    });
</script>
{% endblock %}