{% extends "base.html" %}

{% block title %}Server Status: {{ server.name }} - NEXPOSTGRES{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        transition: all 0.3s;
    }
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .progress {
        height: 10px;
    }
    .status-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .status-online {
        background-color: #28a745;
    }
    .status-offline {
        background-color: #dc3545;
    }
    .status-loading {
        background-color: #ffc107;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { opacity: 0.5; }
        50% { opacity: 1; }
        100% { opacity: 0.5; }
    }
    .server-actions button {
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>Server Status</h1>
        <h4>{{ server.name }} ({{ server.host }})</h4>
    </div>
    <div class="d-flex align-items-center">
        <span id="connection-status">
            <span class="status-indicator status-loading"></span> Connecting...
        </span>
        <a href="{{ url_for('servers.index') }}" class="btn btn-outline-secondary ms-3">
            <i class="fas fa-arrow-left me-1"></i> Back to Servers
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> System Information</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tbody>
                        <tr>
                            <th width="35%"><i class="fas fa-server me-2"></i> Operating System</th>
                            <td id="os-info"><div class="placeholder-glow"><span class="placeholder col-9"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-network-wired me-2"></i> Public IPv4</th>
                            <td id="ip-info"><div class="placeholder-glow"><span class="placeholder col-6"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-microchip me-2"></i> vCPU</th>
                            <td id="vcpu-info"><div class="placeholder-glow"><span class="placeholder col-3"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-memory me-2"></i> RAM</th>
                            <td id="ram-info"><div class="placeholder-glow"><span class="placeholder col-7"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-hdd me-2"></i> Local Disk</th>
                            <td id="disk-info"><div class="placeholder-glow"><span class="placeholder col-8"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-database me-2"></i> PostgreSQL</th>
                            <td id="postgres-version"><div class="placeholder-glow"><span class="placeholder col-6"></span></div></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-archive me-2"></i> pgBackRest</th>
                            <td id="pgbackrest-version"><div class="placeholder-glow"><span class="placeholder col-6"></span></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Resource Usage</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong>CPU Usage</strong>
                        <span id="cpu-percent">--%</span>
                    </div>
                    <div class="progress">
                        <div id="cpu-progress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong>Memory Usage</strong>
                        <span id="memory-percent">--%</span>
                    </div>
                    <div class="progress">
                        <div id="memory-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong>Disk Usage</strong>
                        <span id="disk-percent">--%</span>
                    </div>
                    <div class="progress">
                        <div id="disk-progress" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <p><small>Auto-refreshing every 30 seconds</small></p>
                    <button id="refresh-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt me-1"></i> Refresh Now
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i> Server Controls</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> These actions may cause temporary service disruptions.
                </div>
                
                <div class="server-actions">
                    <button id="restart-btn" class="btn btn-warning">
                        <i class="fas fa-power-off me-1"></i> Restart Server
                    </button>
                    
                    <button id="update-btn" class="btn btn-info">
                        <i class="fas fa-download me-1"></i> Update Server
                    </button>
                    
                    <button id="configure-postgres-btn" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#postgresConfigModal">
                        <i class="fas fa-cog me-1"></i> Configure PostgreSQL Access
                    </button>
                </div>
                
                <div id="action-status" class="mt-3">
                    <!-- Action status messages will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PostgreSQL Configuration Modal -->
<div class="modal fade" id="postgresConfigModal" tabindex="-1" aria-labelledby="postgresConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="postgresConfigModalLabel">
                    <i class="fas fa-database me-2"></i>PostgreSQL Access Configuration
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="postgresConfigForm">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Configure PostgreSQL for remote access.</strong> These settings control how external clients can connect to your PostgreSQL server.
                    </div>
                    
                    <!-- IP Access Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-network-wired me-2"></i>IP Access Control</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Access Type</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="accessType" id="accessAll" value="all" checked>
                                    <label class="form-check-label" for="accessAll">
                                        <strong>Allow All IPs (0.0.0.0/0)</strong>
                                        <small class="text-muted d-block">Allows connections from any IP address</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="accessType" id="accessSpecific" value="specific">
                                    <label class="form-check-label" for="accessSpecific">
                                        <strong>Specific IP Addresses</strong>
                                        <small class="text-muted d-block">Only allow connections from specified IPs</small>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="specificIpsContainer" class="d-none">
                                <label for="allowedIps" class="form-label">Allowed IP Addresses</label>
                                <textarea class="form-control" id="allowedIps" rows="3" placeholder="Enter IP addresses or CIDR blocks, one per line:\n192.168.1.100\n10.0.0.0/24\n203.0.113.5"></textarea>
                                <div class="form-text">Enter IP addresses or CIDR blocks, one per line. Examples: 192.168.1.100, 10.0.0.0/24</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Authentication Method -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Authentication Method</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Authentication Method</label>
                                <div class="form-control-plaintext">
                                    <strong>SCRAM-SHA-256</strong> <span class="text-muted">(Most Secure)</span>
                                </div>
                                <div class="form-text">Using the most secure authentication method available</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SSL/TLS Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-lock me-2"></i>SSL/TLS Configuration</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="enableSsl" checked>
                                <label class="form-check-label" for="enableSsl">
                                    <strong>Enable SSL/TLS</strong>
                                    <small class="text-muted d-block">Encrypt connections to PostgreSQL</small>
                                </label>
                            </div>
                            
                            <div id="sslOptionsContainer">
                                <div class="mb-3">
                                    <label class="form-label">Certificate Management</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="certType" id="autoGenerate" value="auto" checked>
                                        <label class="form-check-label" for="autoGenerate">
                                            <strong>Auto-generate certificates</strong>
                                            <small class="text-muted d-block">Automatically create self-signed certificates</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="certType" id="customCerts" value="custom">
                                        <label class="form-check-label" for="customCerts">
                                            <strong>Use custom certificates</strong>
                                            <small class="text-muted d-block">Provide paths to existing certificate files</small>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="customCertContainer" class="d-none">
                                    <div class="mb-3">
                                        <label for="certPath" class="form-label">Certificate Path</label>
                                        <input type="text" class="form-control" id="certPath" placeholder="/path/to/server.crt">
                                        <div class="form-text">Path to the SSL certificate file</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="keyPath" class="form-label">Private Key Path</label>
                                        <input type="text" class="form-control" id="keyPath" placeholder="/path/to/server.key">
                                        <div class="form-text">Path to the SSL private key file</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration Preview -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Configuration Preview</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">postgresql.conf changes:</label>
                                <pre class="bg-light p-2 rounded"><code id="postgresqlConfPreview">listen_addresses = '*'</code></pre>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">pg_hba.conf entries:</label>
                                <pre class="bg-light p-2 rounded"><code id="pgHbaConfPreview">host    all    all    0.0.0.0/0    scram-sha-256\nhost    all    all    ::/0         scram-sha-256</code></pre>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Validation Options -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Safety Options</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="validateConfig" checked disabled>
                                <label class="form-check-label" for="validateConfig">
                                    <strong>Validate configuration before applying</strong>
                                    <small class="text-muted d-block">Test configuration syntax before restarting PostgreSQL (Always enabled)</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="applyConfigBtn">
                    <i class="fas fa-cog me-1"></i>Apply Configuration
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const serverId = {{ server.id }};
        let refreshInterval;
        
        // Function to fetch server status data
        function fetchServerStatus() {
            document.getElementById('connection-status').innerHTML = '<span class="status-indicator status-loading"></span> Connecting...';
            
            fetch(`{{ url_for('servers.status_data', id=server.id) }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update connection status
                        document.getElementById('connection-status').innerHTML = '<span class="status-indicator status-online"></span> Online';
                        
                        // Update system info
                        document.getElementById('os-info').textContent = data.os;
                        document.getElementById('ip-info').textContent = data.ip;
                        document.getElementById('vcpu-info').textContent = data.vcpu;
                        document.getElementById('ram-info').textContent = `${data.ram.used} MB / ${data.ram.total} MB`;
                        document.getElementById('disk-info').textContent = `${data.disk.used} / ${data.disk.total} (${data.disk.free} free)`;
                        document.getElementById('postgres-version').textContent = data.postgres_version;
                        document.getElementById('pgbackrest-version').textContent = data.pgbackrest_version;
                        
                        // Update resource usage
                        document.getElementById('cpu-percent').textContent = `${data.cpu_usage_percent}%`;
                        document.getElementById('cpu-progress').style.width = `${data.cpu_usage_percent}%`;
                        
                        document.getElementById('memory-percent').textContent = `${data.ram.usage_percent}%`;
                        document.getElementById('memory-progress').style.width = `${data.ram.usage_percent}%`;
                        
                        document.getElementById('disk-percent').textContent = `${data.disk.usage_percent}%`;
                        document.getElementById('disk-progress').style.width = `${data.disk.usage_percent}%`;
                        
                        // Set progress bar colors based on usage
                        setCpuProgressColor(data.cpu_usage_percent);
                        setMemoryProgressColor(data.ram.usage_percent);
                        setDiskProgressColor(data.disk.usage_percent);
                    } else {
                        // Show connection error
                        document.getElementById('connection-status').innerHTML = '<span class="status-indicator status-offline"></span> Offline';
                        showError(`Failed to connect to server: ${data.message}`);
                    }
                })
                .catch(error => {
                    document.getElementById('connection-status').innerHTML = '<span class="status-indicator status-offline"></span> Offline';
                    showError(`Error fetching server status: ${error.message}`);
                });
        }
        
        // Set progress bar colors based on usage thresholds
        function setCpuProgressColor(percent) {
            const progressBar = document.getElementById('cpu-progress');
            if (percent > 80) {
                progressBar.className = 'progress-bar bg-danger';
            } else if (percent > 60) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-info';
            }
        }
        
        function setMemoryProgressColor(percent) {
            const progressBar = document.getElementById('memory-progress');
            if (percent > 80) {
                progressBar.className = 'progress-bar bg-danger';
            } else if (percent > 60) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-success';
            }
        }
        
        function setDiskProgressColor(percent) {
            const progressBar = document.getElementById('disk-progress');
            if (percent > 90) {
                progressBar.className = 'progress-bar bg-danger';
            } else if (percent > 70) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-success';
            }
        }
        
        // Handle restart server button
        document.getElementById('restart-btn').addEventListener('click', function() {
            if (!confirm('Are you sure you want to restart this server? All services will be temporarily unavailable.')) {
                return;
            }
            
            const actionStatus = document.getElementById('action-status');
            actionStatus.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-1"></i> Restarting server...
                </div>
            `;
            
            csrfFetch(`{{ url_for('servers.restart_server', id=server.id) }}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actionStatus.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i> ${data.message}
                        </div>
                    `;
                    // Clear interval and show reconnecting message
                    clearInterval(refreshInterval);
                    setTimeout(() => {
                        document.getElementById('connection-status').innerHTML = 
                            '<span class="status-indicator status-loading"></span> Server restarting, will try to reconnect...';
                        // Try to reconnect after 1 minute
                        setTimeout(() => {
                            fetchServerStatus();
                            startAutoRefresh();
                        }, 60000);
                    }, 2000);
                } else {
                    actionStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-1"></i> ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                actionStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-1"></i> Error: ${error.message}
                    </div>
                `;
            });
        });
        
        // Handle update server button
        document.getElementById('update-btn').addEventListener('click', function() {
            if (!confirm('Are you sure you want to update this server? This may take some time to complete.')) {
                return;
            }
            
            const actionStatus = document.getElementById('action-status');
            actionStatus.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-1"></i> Updating server... This may take several minutes.
                </div>
            `;
            
            csrfFetch(`{{ url_for('servers.update_server', id=server.id) }}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actionStatus.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i> ${data.message}
                        </div>
                    `;
                } else {
                    actionStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-1"></i> ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                actionStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-1"></i> Error: ${error.message}
                    </div>
                `;
            });
        });
        
        // PostgreSQL Configuration Modal functionality
        function updateConfigPreview() {
            const accessType = document.querySelector('input[name="accessType"]:checked').value;
            const authMethod = 'scram-sha-256'; // Fixed to most secure option
            const allowedIps = document.getElementById('allowedIps').value;
            
            // Update postgresql.conf preview
            document.getElementById('postgresqlConfPreview').textContent = "listen_addresses = '*'";
            
            // Update pg_hba.conf preview
            let pgHbaEntries = [];
            
            if (accessType === 'all') {
                pgHbaEntries.push(`host    all    all    0.0.0.0/0    ${authMethod}`);
                pgHbaEntries.push(`host    all    all    ::/0         ${authMethod}`);
            } else {
                const ips = allowedIps.split('\n').filter(ip => ip.trim() !== '');
                ips.forEach(ip => {
                    const cleanIp = ip.trim();
                    if (cleanIp) {
                        pgHbaEntries.push(`host    all    all    ${cleanIp.padEnd(15)}    ${authMethod}`);
                    }
                });
            }
            
            document.getElementById('pgHbaConfPreview').textContent = pgHbaEntries.join('\n');
        }
        
        // Load current PostgreSQL configuration
        function loadCurrentConfig() {
            fetch(`{{ url_for('servers.get_postgres_config', id=server.id) }}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.config) {
                    const config = data.config;
                    
                    // Set access type
                    if (config.access_type === 'all') {
                        document.getElementById('accessAll').checked = true;
                        document.getElementById('specificIpsContainer').classList.add('d-none');
                    } else if (config.access_type === 'specific') {
                        document.getElementById('accessSpecific').checked = true;
                        document.getElementById('specificIpsContainer').classList.remove('d-none');
                        
                        // Set allowed IPs
                        const allowedIpsText = config.allowed_ips.join('\n');
                        document.getElementById('allowedIps').value = allowedIpsText;
                    } else {
                        // Default to 'all' if no configuration found
                        document.getElementById('accessAll').checked = true;
                        document.getElementById('specificIpsContainer').classList.add('d-none');
                    }
                    
                    // Update preview with loaded configuration
                    updateConfigPreview();
                }
            })
            .catch(error => {
                console.error('Error loading current configuration:', error);
                // Set defaults on error
                document.getElementById('accessAll').checked = true;
                document.getElementById('specificIpsContainer').classList.add('d-none');
                updateConfigPreview();
            });
            
            // Load current SSL configuration
            fetch(`{{ url_for('servers.get_ssl_status', id=server.id) }}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.ssl_status) {
                    const sslStatus = data.ssl_status;
                    
                    // Update SSL enable checkbox
                    document.getElementById('enableSsl').checked = sslStatus.ssl_enabled || false;
                    
                    // Update certificate paths if available
                    if (sslStatus.cert_file) {
                        document.getElementById('certPath').value = sslStatus.cert_file;
                    }
                    if (sslStatus.key_file) {
                        document.getElementById('keyPath').value = sslStatus.key_file;
                    }
                    
                    // Determine certificate type based on paths
                    if (sslStatus.cert_file && sslStatus.cert_file.includes('server.crt')) {
                        document.getElementById('autoGenerate').checked = true;
                    } else if (sslStatus.cert_file) {
                        document.getElementById('customCerts').checked = true;
                    }
                    
                    // Trigger change events to show/hide fields
                    const enableSslEvent = new Event('change');
                    document.getElementById('enableSsl').dispatchEvent(enableSslEvent);
                    if (document.getElementById('customCerts').checked) {
                        const customCertsEvent = new Event('change');
                        document.getElementById('customCerts').dispatchEvent(customCertsEvent);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading SSL status:', error);
            });
        }
        
        // Handle access type radio button changes
        document.querySelectorAll('input[name="accessType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const specificContainer = document.getElementById('specificIpsContainer');
                if (this.value === 'specific') {
                    specificContainer.classList.remove('d-none');
                } else {
                    specificContainer.classList.add('d-none');
                }
                updateConfigPreview();
            });
        });
        
        // Handle SSL/TLS configuration changes
        document.getElementById('enableSsl').addEventListener('change', function() {
            const sslContainer = document.getElementById('sslOptionsContainer');
            if (this.checked) {
                sslContainer.classList.remove('d-none');
            } else {
                sslContainer.classList.add('d-none');
            }
        });
        
        // Handle certificate type radio button changes
        document.querySelectorAll('input[name="certType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const customContainer = document.getElementById('customCertContainer');
                if (this.value === 'custom') {
                    customContainer.classList.remove('d-none');
                } else {
                    customContainer.classList.add('d-none');
                }
            });
        });
        
        // Handle allowed IPs textarea changes
        document.getElementById('allowedIps').addEventListener('input', updateConfigPreview);
        
        // Handle apply configuration button
        document.getElementById('applyConfigBtn').addEventListener('click', function() {
            const actionStatus = document.getElementById('action-status');
            const modal = bootstrap.Modal.getInstance(document.getElementById('postgresConfigModal'));
            
            // Collect form data
            const formData = {
                access_type: document.querySelector('input[name="accessType"]:checked').value,
                auth_method: 'scram-sha-256', // Fixed to most secure option
                allowed_ips: document.getElementById('allowedIps').value,
                validate_config: true, // Always validate configuration
                // SSL/TLS configuration
                enable_ssl: document.getElementById('enableSsl').checked,
                cert_type: document.querySelector('input[name="certType"]:checked').value,
                cert_path: document.getElementById('certPath').value,
                key_path: document.getElementById('keyPath').value
            };
            
            // Close modal
            modal.hide();
            
            // Show loading status
            actionStatus.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-1"></i> Configuring PostgreSQL access...
                </div>
            `;
            
            // Send PostgreSQL access configuration request
            csrfFetch(`{{ url_for('servers.configure_postgres_access', id=server.id) }}`, {
                method: 'POST',
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && formData.enable_ssl) {
                    // If PostgreSQL access was configured successfully and SSL is enabled, configure SSL
                    const sslData = {
                        enable_ssl: formData.enable_ssl,
                        auto_generate: formData.cert_type === 'auto',
                        cert_path: formData.cert_path,
                        key_path: formData.key_path
                    };
                    
                    return csrfFetch(`{{ url_for('servers.configure_ssl', id=server.id) }}`, {
                        method: 'POST',
                        body: JSON.stringify(sslData)
                    });
                } else {
                    return Promise.resolve({ json: () => Promise.resolve(data) });
                }
            })
            .then(response => {
                if (response.json) {
                    return response.json();
                } else {
                    return response.json();
                }
            })
            .then(data => {
                if (data.success) {
                    let changeDetails = "";
                    
                    if (data.changes) {
                        changeDetails = "<ul>";
                        
                        if (data.changes.created_files) {
                            changeDetails += "<li><strong>Created missing configuration files</strong></li>";
                        }
                        
                        if (data.changes.listen_addresses) {
                            changeDetails += "<li>Updated postgresql.conf to allow external connections</li>";
                        }
                        
                        if (data.changes.pg_hba) {
                            const accessType = document.querySelector('input[name="accessType"]:checked').value;
                            if (accessType === 'all') {
                                changeDetails += "<li>Updated pg_hba.conf to allow access from all IPs (0.0.0.0/0)</li>";
                            } else {
                                const allowedIps = document.getElementById('allowedIps').value;
                                const ipCount = allowedIps.split('\n').filter(ip => ip.trim() !== '').length;
                                changeDetails += `<li>Updated pg_hba.conf to allow access from ${ipCount} specific IP${ipCount > 1 ? 's' : ''}</li>`;
                            }
                        }
                        
                        if (data.changes.validation_passed) {
                            changeDetails += "<li><strong>Configuration validation passed</strong></li>";
                        }
                        
                        changeDetails += "</ul>";
                    }
                    
                    actionStatus.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i> ${data.message}
                            ${changeDetails}
                        </div>
                    `;
                } else {
                    actionStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-1"></i> <strong>Error:</strong><br>
                            ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                actionStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-1"></i> Error: ${error.message}
                    </div>
                `;
            });
        });
        
        // Handle modal show event to load current configuration
        document.getElementById('postgresConfigModal').addEventListener('show.bs.modal', function() {
            loadCurrentConfig();
        });
        
        // Initialize preview on page load
        updateConfigPreview();
        
        // Handle manual refresh
        document.getElementById('refresh-btn').addEventListener('click', function() {
            fetchServerStatus();
        });
        
        // Show error message
        function showError(message) {
            console.error(message);
        }
        
        // Auto-refresh every 30 seconds
        function startAutoRefresh() {
            refreshInterval = setInterval(fetchServerStatus, 30000);
        }
        
        // Initial fetch and start auto-refresh
        fetchServerStatus();
        startAutoRefresh();
    });
</script>
{% endblock %}