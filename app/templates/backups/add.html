{% extends "base.html" %}
{% from 'macros.html' import page_layout, card_container, form_buttons %}

{% block title %}Add Backup Job - NEXPOSTGRES{% endblock %}

{% block content %}
{% call page_layout('Add Backup Job', url_for('backups.backups'), 'Back to Backup Jobs') %}
    {% call card_container('Job Details') %}
        <form method="post" action="{{ url_for('backups.add_backup') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <!-- Basic Information -->
            <h4 class="border-bottom pb-2 mb-3">Basic Information</h4>
            <div class="mb-3">
                <label for="name" class="form-label">Job Name</label>
                <input type="text" class="form-control" id="name" name="name" required>
                <div class="form-text">A descriptive name for this backup job</div>
            </div>
            
            <div class="mb-3">
                <label for="server_id" class="form-label">Server</label>
                {% if servers %}
                <select class="form-select" id="server_id" name="server_id" required>
                    <option value="" selected disabled>Select a server</option>
                    {% for server in servers %}
                    <option value="{{ server.id }}">{{ server.name }} ({{ server.host }})</option>
                    {% endfor %}
                </select>
                <div class="form-text">
                    <i class="fas fa-info-circle text-info me-1"></i>
                    <strong>Important:</strong> WAL-G performs cluster-level backups that include all databases on the selected server. When partial restore is enabled (default), WAL-G collects metadata that allows restoration of individual databases. Each server can have exactly one backup job.
                </div>
                {% else %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>No servers available</strong><br>
                    All existing servers already have backup jobs. Each server can have only one backup job to ensure simplicity and minimize risk.
                    <hr class="my-2">
                    <small class="text-muted">
                        To create a backup job for a new server, please 
                        <a href="{{ url_for('servers.add_server') }}" class="alert-link">create a new server</a> first.
                    </small>
                </div>
                <select class="form-select" id="server_id" name="server_id" required disabled>
                    <option value="" selected>No servers available</option>
                </select>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label for="cron_expression" class="form-label">Schedule (Cron Expression)</label>
                <input type="text" class="form-control" id="cron_expression" name="cron_expression" placeholder="0 0 * * *" required>
                <div class="form-text">
                    When to run the backup job (cron format: min hour day month weekday)<br>
                    Examples:
                    <code>0 0 * * *</code> - Every day at midnight,
                    <code>0 0 * * 0</code> - Every Sunday at midnight,
                    <code>0 0 1 * *</code> - First day of every month
                </div>
            </div>
            
            <div class="mb-3">
                <label for="retention_count" class="form-label">Retention Policy</label>
                <input type="number" class="form-control" id="retention_count" name="retention_count" value="7" min="1" max="100" required>
                <div class="form-text">
                    Maximum number of backups to keep. Older backups exceeding this limit will be automatically deleted.
                </div>
            </div>
            
            <!-- S3 Storage Settings -->
            <h4 class="border-bottom pb-2 mb-3 mt-5">S3 Storage Settings</h4>
            
            <div class="mb-3">
                <label for="s3_storage_id" class="form-label">S3 Storage Configuration</label>
                <select class="form-select" id="s3_storage_id" name="s3_storage_id" required>
                    <option value="" selected disabled>Select an S3 storage configuration</option>
                    {% for storage in s3_storages %}
                    <option value="{{ storage.id }}">{{ storage.name }} ({{ storage.bucket }} in {{ storage.region }})</option>
                    {% endfor %}
                </select>
                <div class="form-text">
                    Select an S3 storage configuration for this backup job. 
                    <a href="{{ url_for('s3_storage.add') }}" target="_blank">Create a new S3 storage configuration</a> if needed.
                </div>
            </div>
            
            {{ form_buttons(url_for('backups.backups'), 'Create Backup Job', 'fas fa-save') }}
        </form>
    {% endcall %}
{% endcall %}
{% endblock %}