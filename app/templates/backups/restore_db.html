{% extends "base.html" %}

{% block title %}Restore Database - NEXPOSTGRES{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Restore Database</h1>
    <div>
        <a href="{{ url_for('backups.backups') }}" class="btn btn-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i> Back to Backup Jobs
        </a>
        <a href="{{ url_for('backups.restore_logs') }}" class="btn btn-info">
            <i class="fas fa-history me-1"></i> Restore Logs
        </a>
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-light">
        <h5 class="mb-0">Database Restore Options</h5>
    </div>
    <div class="card-body">
        <form method="post" id="restoreForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="restore_type" value="database">
            
            <!-- Database Selection -->
            <h4 class="border-bottom pb-2 mb-3">Database Selection</h4>
            
            <div class="mb-3">
                <label for="database_id" class="form-label">Target Database</label>
                <select class="form-select" id="database_id" name="database_id" required>
                    <option value="" selected disabled>Select a database to restore</option>
                    {% for db in databases %}
                    <option value="{{ db.id }}" data-backup-job-id="{{ db.server.backup_job.id }}">
                        {{ db.name }} on {{ db.server.name }}
                    </option>
                    {% endfor %}
                </select>
                <div class="form-text">Select the database you want to restore</div>
            </div>
            
            <!-- Target Options -->
            <div id="targetOptionsSection">
                <h4 class="border-bottom pb-2 mb-3">Target Options</h4>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="restore_to_same" name="restore_to_same" value="true" checked>
                        <label class="form-check-label" for="restore_to_same">
                            Restore to same database (overwrite existing data)
                        </label>
                    </div>
                    
                    <div id="newDatabaseSection" style="display: none;">
                        <div class="mt-3">
                            <label for="new_database_name" class="form-label">New Database Name</label>
                            <input type="text" class="form-control" id="new_database_name" name="new_database_name" placeholder="Enter new database name">
                            <div class="form-text">If unchecked above, specify a new database name for the restore</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-3" id="backupSelection">
                <h4 class="border-bottom pb-2 mb-3">Backup Selection</h4>
                
                <!-- Point-in-time recovery option -->
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="backup_type" id="point_in_time" value="point_in_time">
                    <label class="form-check-label" for="point_in_time">
                        <strong>Restore to a specific point in time</strong> (Point-in-time recovery)
                    </label>
                </div>
                
                <div class="form-check mt-2">
                    <input class="form-check-input" type="radio" name="backup_type" id="latest_backup" value="latest" checked>
                    <label class="form-check-label" for="latest_backup">
                        <strong>Latest Backup</strong> (Recommended)
                    </label>
                </div>
                
                <div class="form-check mt-2">
                    <input class="form-check-input" type="radio" name="backup_type" id="specific_backup" value="specific">
                    <label class="form-check-label" for="specific_backup">
                        <strong>Specific Backup</strong>
                    </label>
                </div>
            </div>
            
            <!-- Latest Backup Info -->
            <div id="latestBackupInfo" class="mb-3" style="display: none;">
                <div class="card border-info">
                    <div class="card-body">
                        <h6 class="card-title">Latest Backup Information</h6>
                        <div id="latestBackupDetails">Select a database to view latest backup details</div>
                    </div>
                </div>
            </div>
            
            <!-- Specific Backup Selection -->
            <div id="specificBackupSelection" class="mb-3" style="display: none;">
                <label for="backup_log_id" class="form-label">Select Backup</label>
                <select class="form-select" id="backup_log_id" name="backup_log_id">
                    <option value="" selected disabled>Select a specific backup</option>
                </select>
                <div class="form-text">Choose from available backups for the selected database</div>
            </div>
            
            <!-- Point-in-time Selection -->
            <div id="pointInTimeSelection" class="mb-3" style="display: none;">
                <label for="recovery_point" class="form-label">Recovery Point</label>
                <select class="form-select" id="recovery_point" name="recovery_point">
                    <option value="" selected disabled>Select a recovery point</option>
                </select>
                <div class="form-text">Choose a point in time to restore to</div>
            </div>
            
            <!-- Warning Messages -->
            <div id="restoreWarning" class="alert alert-warning mt-4">
                <div id="databaseRestoreWarning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This will restore the selected database. Any data added after the backup/recovery point will be lost.
                </div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button type="button" class="btn btn-secondary me-md-2" onclick="window.history.back();">Cancel</button>
                <button type="submit" class="btn btn-danger" id="restoreButton">
                    <i class="fas fa-database me-1"></i> Start Database Restore
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const databaseSelect = document.getElementById('database_id');
    const specificBackupSelection = document.getElementById('specificBackupSelection');
    const pointInTimeSelection = document.getElementById('pointInTimeSelection');
    const latestBackupInfo = document.getElementById('latestBackupInfo');
    const restoreToSameCheckbox = document.getElementById('restore_to_same');
    const newDatabaseSection = document.getElementById('newDatabaseSection');
    
    // Handle restore to same database checkbox
    restoreToSameCheckbox.addEventListener('change', function() {
        if (this.checked) {
            newDatabaseSection.style.display = 'none';
            document.getElementById('new_database_name').removeAttribute('required');
        } else {
            newDatabaseSection.style.display = 'block';
            document.getElementById('new_database_name').setAttribute('required', 'required');
        }
    });
    
    // Handle database selection change
    databaseSelect.addEventListener('change', function() {
        const databaseId = this.value;
        if (!databaseId) return;
        
        // Get the backup job ID from the selected database option
        const backupJobId = this.options[this.selectedIndex].getAttribute('data-backup-job-id');
        
        // Update content based on selected backup type
        const selectedBackupType = document.querySelector('input[name="backup_type"]:checked')?.value;
        
        if (selectedBackupType === 'specific') {
            loadBackupLogs(backupJobId);
        } else if (selectedBackupType === 'point_in_time') {
            loadRecoveryPoints(databaseId);
        } else if (selectedBackupType === 'latest') {
            loadLatestBackupInfo(backupJobId);
        }
    });
    
    // Handle backup type radio button changes
    document.querySelectorAll('input[name="backup_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // Hide all sections first
            specificBackupSelection.style.display = 'none';
            pointInTimeSelection.style.display = 'none';
            latestBackupInfo.style.display = 'none';
            
            const databaseSelect = document.getElementById('database_id');
            const databaseId = databaseSelect.value;
            const backupJobId = databaseSelect.options[databaseSelect.selectedIndex]?.getAttribute('data-backup-job-id');
            
            if (this.value === 'specific') {
                specificBackupSelection.style.display = 'block';
                if (backupJobId) {
                    loadBackupLogs(backupJobId);
                }
            } else if (this.value === 'point_in_time') {
                pointInTimeSelection.style.display = 'block';
                if (databaseId) {
                    loadRecoveryPoints(databaseId);
                }
            } else if (this.value === 'latest') {
                latestBackupInfo.style.display = 'block';
                if (backupJobId) {
                    loadLatestBackupInfo(backupJobId);
                }
            }
        });
    });
    
    // Load functions
    function loadBackupLogs(backupJobId) {
        fetch(`/backups/api/logs/${backupJobId}`)
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('backup_log_id');
                select.innerHTML = '<option value="" selected disabled>Select a specific backup</option>';
                
                if (data.logs && data.logs.length > 0) {
                    data.logs.forEach(log => {
                        const option = document.createElement('option');
                        option.value = log.id;
                        option.textContent = `${log.backup_type} - ${log.created_at} (${log.status})`;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.textContent = 'No backups available';
                    option.disabled = true;
                    select.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error loading backup logs:', error);
            });
    }
    
    function loadRecoveryPoints(databaseId) {
        fetch(`/backups/api/recovery_points/${databaseId}`)
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('recovery_point');
                select.innerHTML = '<option value="" selected disabled>Select a recovery point</option>';
                
                if (data.recovery_points && data.recovery_points.length > 0) {
                    data.recovery_points.forEach(point => {
                        const option = document.createElement('option');
                        option.value = point.timestamp;
                        option.textContent = point.timestamp;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.textContent = 'No recovery points available';
                    option.disabled = true;
                    select.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error loading recovery points:', error);
            });
    }
    
    function loadLatestBackupInfo(backupJobId) {
        fetch(`/backups/get_backup_logs/${backupJobId}`)
            .then(response => response.json())
            .then(data => {
                const detailsDiv = document.getElementById('latestBackupDetails');
                
                if (data.logs && data.logs.length > 0) {
                    const latestLog = data.logs[0];
                    detailsDiv.innerHTML = `
                        <p><strong>Backup Date:</strong> ${latestLog.created_at}</p>
                        <p><strong>Status:</strong> <span class="badge bg-${latestLog.status === 'completed' ? 'success' : 'warning'}">${latestLog.status}</span></p>
                        <p><strong>Type:</strong> ${latestLog.backup_type}</p>
                        <p><strong>Size:</strong> ${latestLog.backup_size || 'N/A'}</p>
                    `;
                } else {
                    detailsDiv.innerHTML = '<p class="text-muted">No backup information available</p>';
                }
            })
            .catch(error => {
                console.error('Error loading latest backup info:', error);
                document.getElementById('latestBackupDetails').innerHTML = '<p class="text-danger">Error loading backup information</p>';
            });
    }
});
</script>
{% endblock %}