{% extends "base.html" %}

{% block title %}Restore Database - NEXPOSTGRES{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Restore Database</h1>
    <div>
        <a href="{{ url_for('backups.backups') }}" class="btn btn-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i> Back to Backup Jobs
        </a>
        <a href="{{ url_for('backups.restore_logs') }}" class="btn btn-info">
            <i class="fas fa-history me-1"></i> Restore Logs
        </a>
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-light">
        <h5 class="mb-0">Restore Options</h5>
    </div>
    <div class="card-body">
        <form method="post" id="restoreForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <!-- Database Selection -->
            <h4 class="border-bottom pb-2 mb-3">Database Selection</h4>
            
            <div class="mb-3">
                <label for="database_id" class="form-label">Target Database</label>
                <select class="form-select" id="database_id" name="database_id" required>
                    <option value="" selected disabled>Select a database to restore</option>
                    {% for db in databases %}
                    <option value="{{ db.id }}" data-backup-job-id="{{ db.backup_job.id }}">
                        {{ db.name }} on {{ db.server.name }}
                    </option>
                    {% endfor %}
                </select>
                <div class="form-text">Select the database you want to restore (maintains one-to-one relationship with backup jobs)</div>
            </div>
            
            <div class="mb-3" id="backupSelection">
                <label for="backup_type" class="form-label">Backup Selection</label>
                
                <!-- Point-in-time recovery option moved to top -->
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="backup_type" id="point_in_time" value="point_in_time">
                    <label class="form-check-label" for="point_in_time">
                        <strong>Restore to a specific point in time</strong> (Point-in-time recovery)
                    </label>
                </div>
                
                <div class="form-check mt-2">
                    <input class="form-check-input" type="radio" name="backup_type" id="latest_backup" value="latest" checked>
                    <label class="form-check-label" for="latest_backup">
                        <strong>Latest Backup</strong> (Recommended)
                    </label>
                    <div id="latestBackupInfo" class="ms-4 mt-2" style="display: none;">
                        <div class="card border-info">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="text-muted">Loading latest backup information...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-check mt-2">
                    <input class="form-check-input" type="radio" name="backup_type" id="specific_backup" value="specific">
                    <label class="form-check-label" for="specific_backup">
                        <strong>6 Latest Backups</strong> (Choose from last 6 available backups)
                    </label>
                </div>
            </div>
            
            <div class="mb-3" id="specificBackupSelection" style="display: none;">
                <label for="backup_log_id" class="form-label">Available Backups</label>
                <select class="form-select" id="backup_log_id" name="backup_log_id">
                    <option value="" selected disabled>Select database first</option>
                </select>
                <div class="form-text">Hourly backup options will be displayed when available</div>
            </div>
            
            <div class="mb-3" id="pointInTimeSelection" style="display: none;">
                <label for="recovery_date" class="form-label">Recovery Target Date & Time</label>
                <div class="row">
                    <div class="col-md-6">
                        <label for="recovery_date" class="form-label">Select Date (Last 15 Days)</label>
                        <select class="form-select" id="recovery_date" name="recovery_date">
                            <option value="" selected disabled>Select a date</option>
                        </select>
                        <div class="form-text">Choose from the last 15 days</div>
                    </div>
                    <div class="col-md-6">
                        <label for="recovery_time" class="form-label">Available Time Points</label>
                        <select class="form-select" id="recovery_time" name="recovery_time">
                            <option value="" selected disabled>Select date first</option>
                        </select>
                        <div class="form-text">Available backup points for selected date</div>
                    </div>
                </div>
            </div>
            
            <!-- Target Options -->
            <h4 class="border-bottom pb-2 mb-3 mt-5">Target Options</h4>
            
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="restore_to_same" name="restore_to_same" value="true" checked>
                    <label class="form-check-label" for="restore_to_same">Restore to same database</label>
                </div>
                <div class="form-text">When checked, the backup will be restored to the source database. When unchecked, you can select a different target database.</div>
            </div>
            
            <div class="mb-3" id="targetDatabaseDiv" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <label for="target_database_name" class="form-label">New Database Name</label>
                        <input type="text" class="form-control" id="target_database_name" name="target_database_name" placeholder="Enter new database name">
                        <div class="form-text">Name for the restored database</div>
                    </div>
                    <div class="col-md-6">
                        <label for="target_database_id" class="form-label">Target Server</label>
                        <select class="form-select" id="target_database_id" name="target_database_id">
                            <option value="" selected disabled>Select a target server</option>
                            {% for db in databases %}
                            <option value="{{ db.id }}" data-server-name="{{ db.server.name }}">{{ db.server.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Server to restore the database to</div>
                    </div>
                </div>
            </div>
            

            
            <!-- Warning -->
            <div class="alert alert-warning mt-4">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Warning:</strong> Restoring a database will overwrite all existing data in the target database. The target database will be stopped before restore to ensure data integrity. This action cannot be undone.
            </div>
            
            <div class="d-flex justify-content-end">
                <a href="{{ url_for('backups.backups') }}" class="btn btn-secondary me-2">Cancel</a>
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-undo me-1"></i> Start Restore
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const restoreToSameCheckbox = document.getElementById('restore_to_same');
        const targetDatabaseDiv = document.getElementById('targetDatabaseDiv');
        
        // Handle database selection change
        const databaseSelect = document.getElementById('database_id');
        const specificBackupSelection = document.getElementById('specificBackupSelection');
        const pointInTimeSelection = document.getElementById('pointInTimeSelection');
        const latestBackupInfo = document.getElementById('latestBackupInfo');
        
        // Handle database selection change
        databaseSelect.addEventListener('change', function() {
            const databaseId = this.value;
            if (!databaseId) return;
            
            // Get the backup job ID from the selected database option
            const backupJobId = this.options[this.selectedIndex].getAttribute('data-backup-job-id');
            
            // Update content based on selected backup type
            const selectedBackupType = document.querySelector('input[name="backup_type"]:checked')?.value;
            
            if (selectedBackupType === 'specific') {
                loadBackupLogs(backupJobId);
            } else if (selectedBackupType === 'point_in_time') {
                loadRecoveryPoints(databaseId);
            } else if (selectedBackupType === 'latest') {
                loadLatestBackupInfo(backupJobId);
            }
        });
        
        // Handle backup type radio button changes
        document.querySelectorAll('input[name="backup_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // Hide all sections first
                specificBackupSelection.style.display = 'none';
                pointInTimeSelection.style.display = 'none';
                latestBackupInfo.style.display = 'none';
                
                const databaseSelect = document.getElementById('database_id');
                const databaseId = databaseSelect.value;
                const backupJobId = databaseSelect.options[databaseSelect.selectedIndex]?.getAttribute('data-backup-job-id');
                
                if (this.value === 'specific') {
                    specificBackupSelection.style.display = 'block';
                    if (backupJobId) {
                        loadBackupLogs(backupJobId);
                    }
                } else if (this.value === 'point_in_time') {
                    pointInTimeSelection.style.display = 'block';
                    if (databaseId) {
                        loadRecoveryPoints(databaseId);
                    } else {
                        // Initialize date selector even without database selection
                        populateRecoveryDates();
                    }
                } else if (this.value === 'latest') {
                    latestBackupInfo.style.display = 'block';
                    if (backupJobId) {
                        loadLatestBackupInfo(backupJobId);
                    }
                }
            });
        });
        
        // Function to load backup logs (last 6 only)
        function loadBackupLogs(jobId) {
            const backupLogSelect = document.getElementById('backup_log_id');
            
            // Show loading indicator
            backupLogSelect.innerHTML = `
                <option value="" selected disabled>Loading backup logs...</option>
            `;
            
            // Fetch backup logs for selected job with limit
            fetch(`/api/logs/${jobId}?limit=6`)
                .then(response => response.json())
                .then(data => {
                    let options = '<option value="" selected disabled>Select a backup to restore</option>';
                    let hasBackups = false;
                    
                    if (data.logs && data.logs.length > 0) {
                        // Take only the first 6 backups (most recent) without default selection
                        const recentLogs = data.logs.slice(0, 6);
                        recentLogs.forEach(log => {
                            options += `<option value="${log.id}">${log.start_time} - ${log.size_mb ? log.size_mb + ' MB' : 'Size unknown'}</option>`;
                        });
                        hasBackups = true;
                    } else {
                        options = '<option value="" selected disabled>No successful backups available</option>';
                    }
                    
                    // Update backup log select options
                    backupLogSelect.innerHTML = options;
                    
                    // If no backups available, show info message
                    if (!hasBackups) {
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'alert alert-info mt-2';
                        infoDiv.innerHTML = `
                            <i class="fas fa-info-circle me-2"></i>
                            No successful backups found. Please use the "Latest Backup" option instead.
                        `;
                        specificBackupSelection.appendChild(infoDiv);
                    }
                })
                .catch(error => {
                    console.error('Error fetching backup logs:', error);
                    backupLogSelect.innerHTML = `
                        <option value="" selected disabled>Error loading backups</option>
                    `;
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'form-text text-danger';
                    errorDiv.textContent = `Failed to load backup logs: ${error.message}`;
                    specificBackupSelection.appendChild(errorDiv);
                });
        }
        
        // Function to load latest backup info
        function loadLatestBackupInfo(backupJobId) {
            const latestBackupInfo = document.getElementById('latestBackupInfo');
            
            // Show loading state
            latestBackupInfo.innerHTML = `
                <div class="card border-info">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="text-muted">Loading latest backup information...</span>
                        </div>
                    </div>
                </div>
            `;
            
            fetch(`/api/logs/${backupJobId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        const latestLog = data.logs[0]; // Assuming logs are sorted by date desc
                        latestBackupInfo.innerHTML = `
                            <div class="card border-success">
                                <div class="card-body p-3">
                                    <h6 class="card-title mb-2"><i class="fas fa-database me-2"></i>Latest Backup Details</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <strong>Date:</strong><br>
                                            <span class="text-muted">${new Date(latestLog.start_time).toLocaleDateString()}</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Time:</strong><br>
                                            <span class="text-muted">${new Date(latestLog.start_time).toLocaleTimeString()}</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Size:</strong><br>
                                            <span class="text-muted">${latestLog.size_mb ? latestLog.size_mb + ' MB' : 'Unknown'}</span>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <strong>Status:</strong> <span class="badge bg-success">Completed</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        latestBackupInfo.innerHTML = `
                            <div class="card border-warning">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                        <span>No successful backups found for this database.</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching latest backup info:', error);
                    latestBackupInfo.innerHTML = `
                        <div class="card border-danger">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-circle text-danger me-2"></i>
                                    <span>Error loading backup information.</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
        }
        
        // Function to populate last 15 days in date selector
        function populateRecoveryDates() {
            const recoveryDateSelect = document.getElementById('recovery_date');
            const today = new Date();
            
            recoveryDateSelect.innerHTML = '<option value="" selected disabled>Select a date</option>';
            
            for (let i = 0; i < 15; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                const option = document.createElement('option');
                option.value = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                
                // Format with full month name
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                const day = date.getDate();
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                
                option.textContent = `${day} ${month} ${year}`;
                recoveryDateSelect.appendChild(option);
            }
        }
        
        // Function to load recovery times for selected date
        function loadRecoveryTimesForDate(selectedDate, backupJobId) {
            const recoveryTimeSelect = document.getElementById('recovery_time');
            recoveryTimeSelect.innerHTML = '<option value="" selected disabled>Loading...</option>';
            
            fetch(`/api/backups/${backupJobId}/recovery-points?date=${selectedDate}`)
                .then(response => response.json())
                .then(data => {
                    recoveryTimeSelect.innerHTML = '<option value="" selected disabled>Select time point</option>';
                    if (data.recovery_points && data.recovery_points.length > 0) {
                        data.recovery_points.forEach(point => {
                            const option = document.createElement('option');
                            option.value = point.timestamp;
                            option.textContent = `${point.time} (${point.size})`;
                            recoveryTimeSelect.appendChild(option);
                        });
                    } else {
                        recoveryTimeSelect.innerHTML = '<option value="" selected disabled>No recovery points available for this date</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading recovery points:', error);
                    recoveryTimeSelect.innerHTML = '<option value="" selected disabled>Error loading recovery points</option>';
                });
        }
        
        // Function to load recovery points
        function loadRecoveryPoints(databaseId) {
            const databaseSelect = document.getElementById('database_id');
            const backupJobId = databaseSelect.options[databaseSelect.selectedIndex]?.getAttribute('data-backup-job-id');
            
            // Populate the date selector
            populateRecoveryDates();
            
            // Remove any existing event listeners and add new one
            const recoveryDateSelect = document.getElementById('recovery_date');
            const newDateSelect = recoveryDateSelect.cloneNode(true);
            recoveryDateSelect.parentNode.replaceChild(newDateSelect, recoveryDateSelect);
            
            // Add event listener to the new element
            newDateSelect.addEventListener('change', function() {
                const selectedDate = this.value;
                const currentDatabaseSelect = document.getElementById('database_id');
                const currentBackupJobId = currentDatabaseSelect.options[currentDatabaseSelect.selectedIndex]?.getAttribute('data-backup-job-id');
                
                if (selectedDate && currentBackupJobId) {
                    loadRecoveryTimesForDate(selectedDate, currentBackupJobId);
                } else {
                    console.error('Missing date or backup job ID:', { selectedDate, currentBackupJobId });
                    const recoveryTimeSelect = document.getElementById('recovery_time');
                    recoveryTimeSelect.innerHTML = '<option value="" selected disabled>Please select a database first</option>';
                }
            });
        }
        
        // Handle restore to same checkbox
        restoreToSameCheckbox.addEventListener('change', function() {
            if (this.checked) {
                targetDatabaseDiv.style.display = 'none';
                document.getElementById('target_database_id').required = false;
                document.getElementById('target_database_name').required = false;
            } else {
                targetDatabaseDiv.style.display = 'block';
                document.getElementById('target_database_id').required = true;
                document.getElementById('target_database_name').required = true;
            }
        });
        

        
        // Form submission validation
        document.getElementById('restoreForm').addEventListener('submit', function(e) {
            const databaseSelect = document.getElementById('database_id');
            const backupLogSelect = document.getElementById('backup_log_id');
            const recoveryTimeSelect = document.getElementById('recovery_time');
            const recoveryDatetimeInput = document.getElementById('recovery_datetime');
            const backupTypeRadios = document.querySelectorAll('input[name="backup_type"]');
            const selectedBackupType = Array.from(backupTypeRadios).find(radio => radio.checked)?.value;
            const targetDatabaseName = document.getElementById('target_database_name');
            const restoreToSame = document.getElementById('restore_to_same').checked;
            
            // Validate database selection
            if (!databaseSelect.value) {
                e.preventDefault();
                alert('Please select a database first');
                databaseSelect.focus();
                return false;
            }
            
            // Validate backup type selection
            if (!selectedBackupType) {
                e.preventDefault();
                alert('Please select a backup type');
                return false;
            }
            
            // Validate specific backup selection if chosen
            if (selectedBackupType === 'specific') {
                if (!backupLogSelect || !backupLogSelect.value) {
                    const noBackupsAvailable = backupLogSelect && 
                        (!backupLogSelect.options.length || 
                        (backupLogSelect.options.length === 1 && backupLogSelect.options[0].disabled));
                    
                    if (noBackupsAvailable) {
                        e.preventDefault();
                        alert('No specific backups available for this database. Please use "Latest Backup" option instead.');
                        return false;
                    } else {
                        e.preventDefault();
                        alert('Please select a specific backup.');
                        backupLogSelect.focus();
                        return false;
                    }
                }
            }
            
            // Validate point-in-time recovery selection
            if (selectedBackupType === 'point_in_time') {
                const hasRecoveryTime = recoveryTimeSelect && recoveryTimeSelect.value;
                const hasRecoveryDatetime = recoveryDatetimeInput && recoveryDatetimeInput.value;
                
                if (!hasRecoveryTime && !hasRecoveryDatetime) {
                    e.preventDefault();
                    alert('Please select a recovery point or specify a recovery date/time.');
                    return false;
                }
            }
            
            // Validate target database name when not restoring to same database
            if (!restoreToSame && (!targetDatabaseName.value || targetDatabaseName.value.trim() === '')) {
                e.preventDefault();
                alert('Please enter a name for the new database.');
                targetDatabaseName.focus();
                return false;
            }
            
            return true;
        });
        
        // Initialize form state
        if (!restoreToSameCheckbox.checked) {
            targetDatabaseDiv.style.display = 'block';
        }
        
        // Initialize backup type display based on default selection
        const defaultBackupType = document.querySelector('input[name="backup_type"]:checked')?.value;
        if (defaultBackupType === 'latest') {
            latestBackupInfo.style.display = 'block';
        } else if (defaultBackupType === 'point_in_time') {
            pointInTimeSelection.style.display = 'block';
            populateRecoveryDates();
        }
    });
</script>
{% endblock %}