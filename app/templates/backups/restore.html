{% extends "base.html" %}

{% block title %}Restore Database - NEXPOSTGRES{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Restore Database</h1>
    <div>
        <a href="{{ url_for('backups.backups') }}" class="btn btn-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i> Back to Backup Jobs
        </a>
        <a href="{{ url_for('backups.restore_logs') }}" class="btn btn-info">
            <i class="fas fa-history me-1"></i> Restore Logs
        </a>
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-light">
        <h5 class="mb-0">Restore Options</h5>
    </div>
    <div class="card-body">
        <form method="post" id="restoreForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <!-- Database Selection -->
            <h4 class="border-bottom pb-2 mb-3">Database Selection</h4>
            
            <div class="mb-3">
                <label for="database_id" class="form-label">Target Database</label>
                <select class="form-select" id="database_id" name="database_id" required>
                    <option value="" selected disabled>Select a database to restore</option>
                    {% for db in databases %}
                    <option value="{{ db.id }}" data-backup-job-id="{{ db.backup_job.id }}">
                        {{ db.name }} on {{ db.server.name }}
                    </option>
                    {% endfor %}
                </select>
                <div class="form-text">Select the database you want to restore (maintains one-to-one relationship with backup jobs)</div>
            </div>
            
            <div class="mb-3" id="backupSelection">
                <label for="backup_type" class="form-label">Backup Selection</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="backup_type" id="latest_backup" value="latest" checked>
                    <label class="form-check-label" for="latest_backup">
                        <strong>Latest Backup</strong> (Recommended)
                    </label>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="radio" name="backup_type" id="specific_backup" value="specific">
                    <label class="form-check-label" for="specific_backup">
                        <strong>Specific Backup</strong> (Choose from available backups)
                    </label>
                </div>
            </div>
            
            <div class="mb-3" id="specificBackupSelection" style="display: none;">
                <label for="backup_log_id" class="form-label">Available Backups</label>
                <select class="form-select" id="backup_log_id" name="backup_log_id">
                    <option value="" selected disabled>Select database first</option>
                </select>
                <div class="form-text">Hourly backup options will be displayed when available</div>
            </div>
            
            <!-- Target Options -->
            <h4 class="border-bottom pb-2 mb-3 mt-5">Target Options</h4>
            
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="restore_to_same" name="restore_to_same" value="true" checked>
                    <label class="form-check-label" for="restore_to_same">Restore to same database</label>
                </div>
                <div class="form-text">When checked, the backup will be restored to the source database. When unchecked, you can select a different target database.</div>
            </div>
            
            <div class="mb-3" id="targetDatabaseDiv" style="display: none;">
                <label for="target_database_id" class="form-label">Target Database</label>
                <select class="form-select" id="target_database_id" name="target_database_id">
                    <option value="" selected disabled>Select a target database</option>
                    {% for db in databases %}
                    <option value="{{ db.id }}">{{ db.name }} on {{ db.server.name }}</option>
                    {% endfor %}
                </select>
                <div class="form-text">The database to restore to</div>
            </div>
            
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="recovery_target_time" name="use_recovery_time" value="true">
                    <label class="form-check-label" for="recovery_target_time">Restore to a specific point in time</label>
                </div>
                <div class="form-text">When checked, you can specify a point in time to restore to (for point-in-time recovery)</div>
            </div>
            
            <div class="mb-3" id="recoveryTimeDiv" style="display: none;">
                <label for="recovery_time" class="form-label">Recovery Target Time</label>
                <select class="form-select" id="recovery_time" name="recovery_time">
                    <option value="" selected disabled>Select backup job first</option>
                </select>
                <div class="form-text">Available recovery points for selected backup job</div>
            </div>
            
            <!-- Warning -->
            <div class="alert alert-warning mt-4">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Warning:</strong> Restoring a database will overwrite all existing data in the target database. The target database will be stopped before restore to ensure data integrity. This action cannot be undone.
            </div>
            
            <div class="d-flex justify-content-end">
                <a href="{{ url_for('backups.backups') }}" class="btn btn-secondary me-2">Cancel</a>
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-undo me-1"></i> Start Restore
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const restoreToSameCheckbox = document.getElementById('restore_to_same');
        const targetDatabaseDiv = document.getElementById('targetDatabaseDiv');
        const recoveryTargetTimeCheckbox = document.getElementById('recovery_target_time');
        const recoveryTimeDiv = document.getElementById('recoveryTimeDiv');
        
        // Handle database selection change
        const databaseSelect = document.getElementById('database_id');
        const specificBackupRadio = document.getElementById('specific_backup');
        const specificBackupSelection = document.getElementById('specificBackupSelection');
        const latestBackupRadio = document.getElementById('latest_backup');
        
        // Handle database selection change
        databaseSelect.addEventListener('change', function() {
            const databaseId = this.value;
            if (!databaseId) return;
            
            // Get the backup job ID from the selected database option
            const backupJobId = this.options[this.selectedIndex].getAttribute('data-backup-job-id');
            
            // Show loading indicator for backup logs
            backupLogSelection.innerHTML = `
                <label for="backup_log_id" class="form-label">Backup to Restore</label>
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Loading backup logs...</span>
                </div>
            `;
            
            // If specific backup is selected, fetch backup logs
            if (specificBackupRadio.checked) {
                loadBackupLogs(backupJobId);
            }
        });
        
        // Handle backup type radio button changes
        document.querySelectorAll('input[name="backup_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'specific') {
                    specificBackupSelection.style.display = 'block';
                    const databaseSelect = document.getElementById('database_id');
                    const backupJobId = databaseSelect.options[databaseSelect.selectedIndex]?.getAttribute('data-backup-job-id');
                    if (backupJobId) {
                        loadBackupLogs(backupJobId);
                    }
                } else {
                    specificBackupSelection.style.display = 'none';
                }
            });
        });
        
        // Function to load backup logs
        function loadBackupLogs(jobId) {
            const backupLogSelect = document.getElementById('backup_log_id');
            
            // Show loading indicator
            backupLogSelect.innerHTML = `
                <option value="" selected disabled>Loading backup logs...</option>
            `;
            
            // Fetch backup logs for selected job
            fetch(`/api/logs/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    let options = '<option value="" selected disabled>Select a backup to restore</option>';
                    let hasBackups = false;
                    
                    if (data.logs && data.logs.length > 0) {
                        // Add an option for latest backup
                        options = '<option value="latest" selected>Latest backup</option>';
                        
                        data.logs.forEach(log => {
                            options += `<option value="${log.id}">${log.start_time} - ${log.size_mb ? log.size_mb + ' MB' : 'Size unknown'}</option>`;
                        });
                        hasBackups = true;
                    } else {
                        options = '<option value="" selected disabled>No successful backups available</option>';
                    }
                    
                    // Update backup log select options
                    backupLogSelect.innerHTML = options;
                    
                    // If no backups available, show info message
                    if (!hasBackups) {
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'alert alert-info mt-2';
                        infoDiv.innerHTML = `
                            <i class="fas fa-info-circle me-2"></i>
                            No successful backups found. Please use the "Latest Backup" option instead.
                        `;
                        specificBackupSelection.appendChild(infoDiv);
                    }
                })
                .catch(error => {
                    console.error('Error fetching backup logs:', error);
                    backupLogSelect.innerHTML = `
                        <option value="" selected disabled>Error loading backups</option>
                    `;
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'form-text text-danger';
                    errorDiv.textContent = `Failed to load backup logs: ${error.message}`;
                    specificBackupSelection.appendChild(errorDiv);
                });
                
            // Load recovery points when recovery_target_time is checked
                if (recoveryTargetTimeCheckbox.checked) {
                    loadRecoveryPoints(backupJobId);
                }
            });
        }
        
        // Function to load recovery points
        function loadRecoveryPoints(jobId) {
            const recoveryTimeSelect = document.getElementById('recovery_time');
            recoveryTimeSelect.innerHTML = `
                <option value="" selected disabled>Loading recovery points...</option>
            `;
            
            // Get database ID from the selected database
            const databaseSelect = document.getElementById('database_id');
            const databaseId = databaseSelect.value;
            
            if (!databaseId) {
                recoveryTimeSelect.innerHTML = `
                    <option value="" selected disabled>Error: No database selected</option>
                `;
                return;
            }
            
            fetch(`/api/recovery_points/${databaseId}`)
                .then(response => response.json())
                .then(data => {
                    let options = '<option value="" selected disabled>Select a recovery point</option>';
                    
                    if (data.recovery_points && data.recovery_points.length > 0) {
                        data.recovery_points.forEach(point => {
                            options += `<option value="${point.datetime}">${point.formatted} (${point.backup_name})</option>`;
                        });
                    } else {
                        options = '<option value="" selected disabled>No recovery points available</option>';
                    }
                    
                    recoveryTimeSelect.innerHTML = options;
                })
                .catch(error => {
                    console.error('Error fetching recovery points:', error);
                    recoveryTimeSelect.innerHTML = `
                        <option value="" selected disabled>Error loading recovery points</option>
                    `;
                });
        }
        
        // Handle restore to same checkbox
        restoreToSameCheckbox.addEventListener('change', function() {
            if (this.checked) {
                targetDatabaseDiv.style.display = 'none';
                document.getElementById('target_database_id').required = false;
            } else {
                targetDatabaseDiv.style.display = 'block';
                document.getElementById('target_database_id').required = true;
            }
        });
        
        // Handle recovery target time checkbox
        recoveryTargetTimeCheckbox.addEventListener('change', function() {
            const recoveryTimeSelect = document.getElementById('recovery_time');
            if (this.checked) {
                recoveryTimeDiv.style.display = 'block';
                recoveryTimeSelect.required = true;
                
                // Make backup log selection not required when using point-in-time recovery
                const backupLogSelect = document.getElementById('backup_log_id');
                if (backupLogSelect) {
                    backupLogSelect.required = false;
                }
                
                // Load recovery points if database is already selected
                const databaseSelect = document.getElementById('database_id');
                const selectedDatabaseId = databaseSelect.value;
                if (selectedDatabaseId) {
                    const backupJobId = databaseSelect.options[databaseSelect.selectedIndex].getAttribute('data-backup-job-id');
                    loadRecoveryPoints(backupJobId);
                }
            } else {
                recoveryTimeDiv.style.display = 'none';
                recoveryTimeSelect.required = false;
                
                // Make backup log selection required again
                const backupLogSelect = document.getElementById('backup_log_id');
                if (backupLogSelect) {
                    backupLogSelect.required = true;
                }
            }
        });
        
        // Form submission validation
        document.getElementById('restoreForm').addEventListener('submit', function(e) {
            const databaseSelect = document.getElementById('database_id');
            const backupLogSelect = document.getElementById('backup_log_id');
            const useRecoveryTime = recoveryTargetTimeCheckbox.checked;
            const recoveryTimeSelect = document.getElementById('recovery_time');
            const recoveryTimeValue = recoveryTimeSelect.value;
            const backupTypeRadios = document.querySelectorAll('input[name="backup_type"]');
            const selectedBackupType = Array.from(backupTypeRadios).find(radio => radio.checked)?.value;
            
            // Check if there are real recovery points available (not just placeholder options)
            const recoveryPointsAvailable = Array.from(recoveryTimeSelect.options).some(option => 
                !option.disabled && !option.textContent.includes('No recovery points available')
            );
            
            // Validate database selection
            if (!databaseSelect.value) {
                e.preventDefault();
                alert('Please select a database first');
                databaseSelect.focus();
                return false;
            }
            
            // Validate specific backup selection if chosen
            if (selectedBackupType === 'specific' && (!backupLogSelect || !backupLogSelect.value)) {
                const noBackupsAvailable = backupLogSelect && 
                    (!backupLogSelect.options.length || 
                    (backupLogSelect.options.length === 1 && backupLogSelect.options[0].disabled));
                
                if (noBackupsAvailable) {
                    e.preventDefault();
                    alert('No specific backups available for this database. Please use "Latest Backup" option instead.');
                    return false;
                } else {
                    e.preventDefault();
                    alert('Please select a specific backup or choose "Latest Backup" option.');
                    return false;
                }
            }
            
            // Only validate recovery point selection if:
            // 1. Point-in-time recovery is enabled AND
            // 2. There are recovery points available AND
            // 3. No recovery point is selected
            if (useRecoveryTime && recoveryPointsAvailable && !recoveryTimeValue) {
                e.preventDefault();
                alert('Please select a recovery point');
                return false;
            }
            
            // If point-in-time recovery is enabled but no recovery points are available,
            // allow the form to submit if a database is selected
            if (useRecoveryTime && !recoveryPointsAvailable) {
                console.log('No recovery points available, using latest backup instead');
            }
            
            return true;
        });
        
        // Initialize form state
        if (!restoreToSameCheckbox.checked) {
            targetDatabaseDiv.style.display = 'block';
        }
        
        if (recoveryTargetTimeCheckbox.checked) {
            recoveryTimeDiv.style.display = 'block';
        }
    });
</script>
{% endblock %}